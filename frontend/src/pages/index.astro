---
import { gql } from 'graphql-request'
import { backendBase, graphqlClient } from '../lib/graphqlClient'

let pageTitle = 'BG Info Enrollment'
let pageDescription = 'Информация за записване'

type MediaDoc = { url?: string; alt?: string } | null
type InfoItem = { info?: string | null; id?: string | null }
type HomeDoc = {
  meta?: { metaTitle?: string | null; metaDescription?: string | null }
  heroImage?: MediaDoc | null
  infoList?: InfoItem[] | null
}

const HOME_QUERY = gql`
  query HomeContent {
    Home {
      meta {
        metaTitle
        metaDescription
      }
      heroImage: HeroImage {
        url
        alt
      }
      infoList: InfoList {
        id
        info
      }
    }
  }
`

let homeData: HomeDoc | null = null
let homeError = ''

try {
  const data = await graphqlClient.request<{ Home?: HomeDoc; GlobalHome?: HomeDoc }>(HOME_QUERY)
  homeData = data.Home ?? data.GlobalHome ?? null
} catch (err) {
  homeError = err instanceof Error ? err.message : 'Failed to load data'
}

const heroImage = homeData?.heroImage ?? null
const headerImageUrl =
  (heroImage?.url ? (heroImage.url.startsWith('http') ? heroImage.url : `${backendBase}${heroImage.url}`) : '/img/header.png') ||
  '/img/header.png'
const headerAlt = heroImage?.alt || 'BG Info header image'

const infoItems = Array.isArray(homeData?.infoList)
  ? (homeData.infoList as InfoItem[]).filter((item) => item?.info)
  : []

pageTitle = homeData?.meta?.metaTitle ?? pageTitle
pageDescription = homeData?.meta?.metaDescription ?? pageDescription
---

<!DOCTYPE html>
<html lang="bg">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={pageDescription} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/css/bootstrap.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <title>{pageTitle}</title>
  </head>
  <body>
    <main class="container body-content">
      <img class="img-responsive center-block" src={headerImageUrl} alt={headerAlt} />
      <p class="visible-xs-block">&nbsp;</p>
      <section class="container">
        <h4>Информация за преписка</h4>
        <hr />
        <p>&nbsp;</p>
        <p class="sr-only">Моля въведете Вашият входящ номер и ПИН код, за да проверите статуса на преписката.</p>

        <div class="validation-summary-errors text-danger" aria-live="polite">
          <ul id="validation-list">
            <li class="text-muted"></li>
          </ul>
        </div>

        <form id="request-form">
          <div class="row">
            <div class="col-xs-12 col-sm-4">
              <div class="well">
                <div class="form-group">
                  <label for="reqNum" class="control-label">Молба вх.номер</label>
                  <input
                    type="text"
                    class="form-control"
                    id="reqNum"
                    name="reqNum"
                    value=""
                    required
                    title="Моля въведете Вашият входящ номер"
                    placeholder=""
                  />
                  <span class="help-block"></span>
                </div>
                <div class="form-group">
                  <label for="pin" class="control-label">ПИН</label>
                  <input
                    type="text"
                    class="form-control"
                    id="pin"
                    name="pin"
                    value=""
                    required
                    title="Моля въведете Вашият входящ ПИН"
                  />
                  <span class="help-block"></span>
                </div>
                <button type="submit" class="btn btn-brown" id="submit-btn">Провери</button>
              </div>
            </div>
            <div class="col-xs-12 col-sm-8">
              <ul class="list-unstyled info-list">
                {infoItems.length > 0 ? (
                  infoItems.map((item) => (
                    <li>
                      - {item.info}
                    </li>
                  ))
                ) : (
                  <li class="text-muted">
                    Добавете записи в глобала “Home” в админ панела на Payload, за да се покажат тук.
                  </li>
                )}
              </ul>
              {homeError && <p class="text-danger">Неуспешно зареждане на данните: {homeError}</p>}
            </div>
          </div>
        </form>
      </section>

      <section class="container" style="margin: 30px auto 0 auto; text-align: justify">
        <hr />
        <p></p>
        <hr />
        <footer>
          <p>&copy; 2025 - Дирекция Българско гражданство</p>
        </footer>
      </section>
    </main>
  </body>
</html>

<script type="module">
  const form = document.getElementById('request-form')
  const reqNumInput = document.getElementById('reqNum')
  const pinInput = document.getElementById('pin')
  const submitBtn = document.getElementById('submit-btn')
  const validationList = document.getElementById('validation-list')

  const setMessages = (messages, muted = false) => {
    if (!validationList) return
    validationList.innerHTML = ''
    if (!messages.length && muted) {
      const li = document.createElement('li')
      li.className = 'text-muted'
      li.textContent = 'Попълнете формата и натиснете "Провери".'
      validationList.appendChild(li)
      return
    }
    messages.forEach((msg) => {
      const li = document.createElement('li')
      li.textContent = msg
      validationList.appendChild(li)
    })
  }

  form?.addEventListener('submit', async (event) => {
    event.preventDefault()
    const errors = []
    const reqNumber = reqNumInput?.value.trim() || ''
    const pin = pinInput?.value.trim() || ''

    if (!reqNumber) errors.push('Въведете номер на молба')
    if (!pin) errors.push('Въведете ПИН')
    setMessages(errors, true)
    if (errors.length) return

    if (submitBtn) submitBtn.disabled = true
    setMessages(['Търсене...'])

    try {
      const res = await fetch('/api/request-lookup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reqNumber, pin }),
      })
      const json = await res.json()

      if (!res.ok) {
        throw new Error(json?.error || 'Lookup failed')
      }

      const docs = json?.docs || []
      console.log('Request lookup:', docs)
      if (docs.length === 0) {
        setMessages(['Липсва молба с така въведените данни'])
      } else {
        setMessages(['Намерени записи: ' + docs.length])
      }
    } catch (err) {
      console.error('Lookup failed', err)
      setMessages(['Неуспешна проверка. Опитайте отново.'])
    } finally {
      if (submitBtn) submitBtn.disabled = false
    }
  })
</script>
